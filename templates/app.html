<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>radiologytemplates.org</title>
    <link type="text/css" rel="stylesheet" href="%% url_for('static', filename='css/bootstrap.min.css')%%" />
    <link type="text/css" rel="stylesheet" href="%% url_for('static', filename='css/bootstrap-vue.css')%%" />
    <link type="text/css" rel="stylesheet" href="%% url_for('static', filename='css/mytemplate.css')%%" />
    <!-- Required scripts -->
    <script src="%% url_for('static', filename='js/vue.js')%%"></script>
    <script src="%% url_for('static', filename='js/bootstrap-vue.js')%%"></script>
    <script src="%% url_for('static', filename='js/lodash.js')%%"></script>
    <script src="%% url_for('static', filename='js/my_lib.js')%%"></script>
</head>

<body>
    <div id="app">
        <b-navbar type="dark" variant="info" class="shadow p-3 mb-5">
            <b-navbar-brand href="#"><img src="%% url_for('static', filename='img/icon.svg')%%" height="15px" class="d-inline-block " alt="Kitten"/>
                radiologytemplates.org</b-navbar-brand>
            <b-navbar-nav>
                <b-nav-item-dropdown v-if="logged_in" :text="user_name" right>
                    <b-dropdown-item @click="save_prefs()" href="/user">User preferences
                    </b-dropdown-item>
                    <b-dropdown-item v-b-modal.template-download>Import templates from RadReport.com
                    </b-dropdown-item>
                    <b-dropdown-item v-b-modal.import-modal>Import templates from file
                    </b-dropdown-item>
                    <b-dropdown-item @click="save_prefs(); logout()">Log out</b-dropdown-item>
                </b-nav-item-dropdown>
            </b-navbar-nav>
        </b-navbar>
        <p></p>
        <b-modal id="help_modal" title="Help" ok-only>
            <h3>What is this for?</h3>
            <p>This site allows the use of templates for reporting radiological studies. Prewritten templates can be downloaded from the Template Store which can then be modified or templates can be written from scratch.</p>
            <h3>I'm still confused. How do I use it?</h3>
            <p>Select a template from below by clicking on it. This will open up a new page which displays the template for you to fill in. </p>
            <p>When you have finished click on "Show Report" and a textual report will be generated and copied to the clipboard. You can then modify if necessary and paste in to your PACS/RIS software.</p>
            <h3>Where do I get more templates?</h3>
            <p>Go the the Template Store to download more templates. </p>
            <h3>But I don't like the templates. They don't fit my style of reporting.</h3>
            <p>Templates can be modified to fit your checklists and specific wording. You can then save them for use next time. </p>
            <h3>I just want a blank template though.</h3>
            <p>Sure. Click on the Blank Template button. </p>
            <h3>I want a template that does not exist yet.</h3>
            <p>Choose a blank template or one that is similar to the one you want. Make any modifications you need and then click Save as New. </p>

            <h3>But I still don't understand!!!</h3>
            <p>Email me at: jeremy.lynch@gmail.com </p>
        </b-modal>
        <b-modal id="template_help_modal" title="Help" ok-only>
            <h3>How do I use this?</h3>
            <p>Fill in the entries below to report the radiological study. When you are done click the green Show Report button. The report will be generated and displayed to you for you to review and edit if necessary. Click "Copy report to clipboard" if you are satisfied. When you are done click "Finish and clear for next" to start a new report.  </p>
            <h3>But I need to add some more text.</h3>
            <p>Click on the Edit button that appears next to your mouse cursor on the left and then click Insert Text.</p>
            <h3>I want to change the prewritten template elements. </h3>
            <p>Sure. Click on Edit and then Edit Element and then you can change the generated text and options. You can also insert new Components or Modules </p>
            <h3>What is a Module?</h3>
            <p>A Module is a group of components that are commonly reused. For example a collection of checklist items (e.g. acute infarct present/not present, acute haemorrhage present/not present. </p>
            <h3>Can I save the changes to the template for use next time?</h3>
            <p>Naturally. Click Template → Save Changes. You can also save it as a new template by clicking Template → Save as New </p>
        </b-modal>
        <b-modal id="position-insert-modal" title="Where?">
            <p>Would you like to insert at the beginning of template or below this component </p>
            <b-button @click="$bvModal.hide('position-insert-modal'); insertObject(object.type, 'above')">Beginning of template</b-button>
            <b-button @click="$bvModal.hide('position-insert-modal'); insertObject(object.type, 'below')">Below this component</b-button>
            <template #modal-footer="{ close }">
                <b-button variant="danger" @click="$bvModal.hide('position-insert-modal'); object.type=null">Cancel</b-button>
            </template>
        </b-modal>
        <b-modal id="template-download" title="RadReport.Com">
            <p>Experimental import of RSNA approved templates on RadReport.com (Experimental!!)</p>
            <b-button v-if="importing" variant="primary" disabled>
                Importing template...
                <b-spinner small></b-spinner>
            </b-button>
            <div v-if="!importing">
                <b-input-group>
                    <b-form-input v-model="radreport_search_term"></b-form-input>
                    <b-input-group-append>
                        <b-button @click="update_radreport_search(); show_count=true" variant="success">Search</b-button>
                    </b-input-group-append>
                </b-input-group>
                <p></p>
                <p v-if="show_count">{{radreport_table.length}} items found</p>
                <b-table sticky-header striped hover head-variant="light" :items="radreport_table">
                    <template #cell(title)="row">
                        <b-button variant="link" size="sm" @click="importing=true; download_radreport(row.item)">
                            {{row.item.title}}
                        </b-button>
                    </template>
                </b-table>
            </div>
            <template #modal-footer="{ close }">
                <b-button variant="danger" @click="$bvModal.hide('template-download')">Cancel</b-button>
            </template>
        </b-modal>
        <b-modal id="import-modal" title="Import">
            <p>Import templates/modules </p>
            <b-form-file v-model="import_file" class="mt-3" plain></b-form-file>
            <template #modal-footer="{ close }">
                <b-button @click="import_templates_from_file(import_file); $bvModal.hide('import-modal')">Submit</b-button>
            </template>
        </b-modal>
        <b-modal :id="copyModal.id" :title="copyModal.title" ok-only>

            <p class="small">Time: {{timer.min}} min</p>
            <b-card no-body>

            <b-tabs ref="copyTabs" v-model="prefs.copytab"  card>
              <b-tab title="Original">
                <b-form-group>
                  <b-form-textarea rows="12" :value="copyModal.text" @change="copyModal.text = $event; copyModal.text_changed=true"></b-form-textarea>
                </b-form-group>
              </b-tab>
              <b-tab title="AI edited" @click="AIReview()">
                <b-form-group>
                  <b-form-textarea rows="15" :value="copyModal.ai_text" @change="copyModal.ai_text = $event" placeholder="Generating report using AI..."></b-form-textarea>
                </b-form-group>
                <div v-if="prefs.copytab === 1">
                  <b-form-checkbox v-model="prefs.generate_conclusion" @change="copyModal.text_changed = true; AIReview(); save_prefs()">Generate automatic conclusion</b-form-checkbox>
                </div>
              </b-tab>
            </b-tabs>
            </b-card>
            <p></p>
            <b-form-group>
                <b-form-checkbox v-model="prefs.include_signature" @click="save_prefs()">Add signature</b-form-checkbox>
                <b-form-input
                  v-if="prefs.include_signature"
                  :value="prefs.signature"
                  @change="prefs.signature = $event; save_prefs()"
                  placeholder="Enter your signature"
                ></b-form-input>
            </b-form-group>
            <template #modal-footer="{ close }">
                <!-- <b-button @click="AIReview()" variant="success">{{ AIButtonText }}</b-button> -->
                <b-button @click="clipboardReport();" variant="success">{{ copyButtonText }}</b-button>
                <b-button @click="prefs.report_count_today++; clearTemplate(); close(); save_prefs()" variant="info">Finish and clear</b-button>
                <b-button @click="close()" variant="danger">Cancel</b-button>
            </template>
        </b-modal>
        <b-modal :id="xmlModal.id" :title="xmlModal.title" ok-only>
            <b-form-group>
                <b-form-textarea rows="20" :value="xmlModal.text">
                </b-form-textarea>
            </b-form-group>
        </b-modal>
        <b-container fluid="sm" v-if="!logged_in">
            <p>Logged out. </p>
            <p>Follow this to
                <b-link href="/">log in</b-link>
            </p>
        </b-container>
        <b-container fluid="sm" v-if="logged_in">
            <b-alert :show="alert_countdown" @dismissed="alert_countdown=0" dismissible variant="warning">
                {{alert_message}}
            </b-alert>
            <b-form-group v-if=" template == ''" id="select_template" title="Select Template" ok-only>
                <b-form-group>
                    <div v-if="this.templates.findIndex(n => {
                    return (n.name == 'Blank');
                }) != -1">
                        <b-button variant="primary" @click="blankTemplate()">Blank Template</b-button>
                        <b-button @click="save_prefs()" variant="warning" href="/store">Template store
                        </b-button>
                        <!--<b-button @click="import_templates_from_server('neuro.xml'); $bvModal.hide('template-download')">Import neuroradiology template starter</b-button>-->
                        <b-button v-b-modal.help_modal variant="info">Help
                        </b-button>
                    </div>
                    <p></p>
                    <b-card no-body>
                        <b-tabs v-model="prefs.current_tab" @input="save_prefs()" card>
                            <b-tab v-for="x in specialties" v-if="items_in_list(x) && x !='Generic' && x !='Other'" :key="'dyn-tab-' + x" :title="x">
                                <template v-for="y in modalities">
                                    <h3 v-if="items_in_list(x, y)">{{y}}</h3>
                                    <template v-for="z in regions">
                                        <h4 style="font-size:small" v-if="items_in_list(x, y, z)">{{z}}</h4>
                                        <template v-for="n in templates">
                                            <b-button @click="mode = 'templates'; selectTemplate(n)" variant="link" v-if="n.specialty==x && n.modality ==y && n.region ==z">{{n.name}} </b-button>
                                        </template>
                                    </template>
                                </template>
                            </b-tab>
                            <b-tab>
                                <template #title>
                                    <div style="color: red">Modules</div>
                                </template>
                                <p>Modules are collections of template elements that can be inserted in to templates.</p>
                                <template v-for="n in templates.modules">
                                    <b-button @click="mode = 'modules'; selectTemplate(n)" variant="link">{{n.name}} </b-button>
                                </template>
                            </b-tab>
                            <b-form-group v-if="templates.length < 3">
                                <b-card border-variant="light">
                                    <b-jumbotron lead="Download templates">
                                        <p>You don't have many templates. Would you like to download some?</p>
                                        <b-button variant="primary" href="/store">Visit the template store</b-button>
                                    </b-jumbotron>
                                </b-card>
                            </b-form-group>
                        </b-tabs>
                    </b-card>
                </b-form-group>
            </b-form-group>
            <!--<b-form-group v-if="mode=='modules' && template == ''">
                <b-form-group>
                    <p></p>
                    <b-button @click="mode='templates'">Back to templates</b-button>
                    <p></p>
                    <div v-if="this.templates.modules.findIndex(n => {
                    return (n.name == 'Blank');
                }) != -1">
                        <b-button variant="primary" @click="blankModule()">Blank Module</b-button>
                        </b-button>
                    </div>
                    <h1>Modules</h1>
                    <template v-for="n in templates.modules">
                        <b-button @click="mode = 'modules'; selectTemplate(n)" variant="link">{{n.name}} </b-button>
                    </template>
                </b-form-group>
            </b-form-group>-->
            <b-modal id="insert-component-modal" title="Insert Component" ok-only>
                <b-form-group label-for="search_module">
                    <p></p>
                    <b-button @click="insertComponent('Text Entry')">Text</b-button>
                    <p></p>
                    <b-button @click="insertComponent('h1')">Large Header</b-button>
                    <p></p>
                    <b-button @click="insertComponent('h2')">Small Header</b-button>
                    <p></p>
                    <b-button @click="insertComponent('Selection')">Selection</b-button>
                    <p></p>
                    <b-button @click="insertComponent('Multi Select')">Multi Selection</b-button>
                    <p></p>
                    <b-button @click="insertComponent('Multi Checkbox')">Multi Checkbox</b-button>
                    <p></p>
                    <b-button @click="insertComponent('Multi Radio')">Multi Radio</b-button>
                    <p></p>
                    <b-button @click="insertComponent('Query Insert')">Query insert</b-button>
                </b-form-group>
                <template #modal-footer="{ close }">
                    <b-button @click="close()" variant="danger">Cancel</b-button>
                </template>
            </b-modal>
            <b-modal id="control_modal" title="Insert Module" ok-only>
                <template v-for="n in templates.modules">
                    <b-button @click="insertModule(n.name, 'below'); $bvModal.hide('control_modal')" variant="link">{{n.name}} </b-button>
                </template>
                <template #modal-footer="{ close }">
                    <b-button @click="close()" variant="danger">Cancel</b-button>
                </template>
            </b-modal>
            <!-- EDIT THE SELECTED ELEMENT -->
            <b-modal v-if="selected_n !=null" id="edit_modal" :title="'Edit ' + selected_n.type" ok-only>
                <div class="edit_style">
                    <p v-if="selected_n.meta.this_is_module">Part of module: <b>{{selected_n.meta.module_name}} </b></p>
                    <!-- QUERY INSERT TYPE -->
                    <b-form-group v-if="selected_n.type=='query_insert'" class="indent_bug">
                        <b-form-checkbox v-model="selected_n.disappear">Diseappear after insertion?</b-form-checkbox>
                        <b-input-group>
                            <template v-for="n in templates.modules">
                                <b-button @click="selected_n.text = n.name; $bvModal.hide('edit_modal')" variant="link">{{n.name}} </b-button>
                            </template>
                        </b-input-group>
                        <p></p>
                    </b-form-group>
                    <!-- HEADER TYPE -->
                    <b-form-group v-if="selected_n.type=='h1' || selected_n.type=='h2'" class="indent_bug">
                        <b-input-group prepend="Header label">
                            <b-form-input :value="selected_n.label" @change="selected_n.label = $event"></b-form-input>
                        </b-input-group>
                        <p></p>
                        <b-form-checkbox v-model="selected_n.dont_print">Omit heading from report?</b-form-checkbox>
                        <b-form-checkbox v-model="selected_n.print_space">Print spaces after heading?</b-form-checkbox>
                        <p></p>
                    </b-form-group>
                    <!--  TEXT TYPE -->
                    <b-form-group v-if=" selected_n.type=='text_entry'" class="indent_bug">
                        <b-input-group prepend="Element label">
                            <b-form-input :value="selected_n.label" @change="selected_n.label = $event">
                            </b-form-input>
                        </b-input-group>
                        <b-input-group prepend="Text to insert after">
                            <b-form-input :value="selected_n.print_text_after" @change="selected_n.print_text_after = $event">
                            </b-form-input>
                        </b-input-group>
                        <p></p>
                        <b-form-radio-group v-model="selected_n.subtype" name="radio-options">
                            <b-form-radio value="small">Small</b-form-radio>
                            <b-form-radio value="medium">Medium</b-form-radio>
                            <b-form-radio value="large">Large</b-form-radio>
                        </b-form-radio-group>
                        <b-form-checkbox v-model="selected_n.dont_print_label">Omit label in report?</b-form-checkbox>
                        <p></p>
                        <label>Content:</label>
                        <b-form-textarea :value="selected_n.template_text" @change="selected_n.template_text = $event;  selected_n.text = selected_n.template_text">
                        </b-form-textarea>
                    </b-form-group>
                    <!-- SELECTION TYPE -->
                    <b-form-group v-if="selected_n.type == 'selection'" class="indent_bug">
                        <b-input-group prepend="Element label">
                            <b-form-input :value="selected_n.label" @change="selected_n.label = $event">
                            </b-form-input>
                        </b-input-group>
                        <b-form-checkbox v-model="selected_n.dont_print_label">Omit heading from report?</b-form-checkbox>
                        <p></p>
                        <label>Options:</label>
                        <template v-for=" n in selected_n.options">
                            <b-row>
                                <b-col cols="8">
                                    <b-form-input :value="n.text" @change="n.text = $event">
                                    </b-form-input>
                                </b-col>
                                <b-col>
                                    <b-button-group>
                                        <b-button variant="danger" @click=" selected_n.options.splice(selected_n.options.indexOf(n), 1)">Delete</b-button>
                                        <b-button variant="success" @click="selected_n.options.splice(selected_n.options.indexOf(n)+1, 0, {'text': '', 'value': selected_n.options.indexOf(n)+1})">Add</b-button>
                                    </b-button-group>
                                </b-col>
                            </b-row>
                        </template>
                    </b-form-group>
                    <!-- MULTISELECTION TYPE -->
                    <b-form-group v-if="selected_n.type=='multi_select'" class="indent_bug">
                        <b-input-group prepend="Element label">
                            <b-form-input :value="selected_n.label" @change="selected_n.label = $event">
                            </b-form-input>
                        </b-input-group>
                        <p></p>
                        <b-form>
                            <label>Ask further details? </label>
                            <b-form-radio-group v-model="selected_n.askfurtherdetails">
                                <b-form-radio value='true'> Yes</b-form-radio>
                                <b-form-radio value='false'> No</b-form-radio>
                            </b-form-radio-group>
                            <b-input-group prepend="Text to include in report if 'No'">
                                <b-form-input :value="selected_n.normaltext" @change="selected_n.normaltext = $event">
                                </b-form-input>
                            </b-input-group>
                        </b-form>
                        <p></p>
                        <b-button variant="success" @click="selected_n.multi.splice(0, 0, {'label': 'Enter label', 'text':'', 'type':'dropdown', 'options': [{'text': '', 'value':''}, {'text': 'Other', 'value':'Other'}]})">Insert selection</b-button>
                        <b-button variant="success" @click="selected_n.multi.splice(0, 0, {'text':'', 'type':'free_text', 'text':''})">Insert text box</b-button>
                        <template v-for="nn in selected_n.multi">
                            <p></p>
                            <b-card>
                                <template #header>
                                    <b-button variant="danger" class="float-right" @click="selected_n.multi.splice(selected_n.multi.indexOf(nn), 1)">Delete</b-button>
                                </template>
                                <b-input-group prepend="Label">
                                    <b-form-input :value="nn.label" @change="nn.label = $event">
                                    </b-form-input>
                                </b-input-group>
                                <b-input-group prepend="Text preceeding">
                                    <b-form-input :value="nn.print_text_before" @change="nn.print_text_before = $event">
                                    </b-form-input>
                                </b-input-group>
                                <b-input-group prepend="Text inserted after">
                                    <b-form-input :value="nn.print_text_after" @change="nn.print_text_after = $event">
                                    </b-form-input>
                                </b-input-group>
                                <template v-if="nn.type=='dropdown'" v-for="n_dropdown in nn.options">
                                    <p></p>
                                    <b-row>
                                        <b-col cols="8">
                                            <b-form-input :value="n_dropdown.text" @change="n_dropdown.text = $event">
                                            </b-form-input>
                                        </b-col>
                                        <b-col>
                                            <b-button-group>
                                                <b-button variant="danger" @click=" nn.options.splice(nn.options.indexOf(n_dropdown), 1)">-</b-button>
                                                <b-button variant="success" @click="nn.options.splice(nn.options.indexOf(n_dropdown)+1, 0, {'text': '', 'value': nn.options.indexOf(n_dropdown)+1})">+</b-button>
                                            </b-button-group>
                                        </b-col>
                                    </b-row>
                                </template>
                            </b-card>
                            <p></p>
                            <b-button variant="success" @click="selected_n.multi.splice(selected_n.multi.indexOf(nn)+1, 0, {'label': 'Enter label', 'text':'', 'type':'dropdown', 'options': [{'text': '', 'value':''}, {'text': 'Other', 'value':'Other'}]})">Insert selection</b-button>
                            <b-button variant="success" @click="selected_n.multi.splice(selected_n.multi.indexOf(nn)+1, 0, {'text':'', 'type':'free_text', 'text':''})">Insert text box</b-button>
                        </template>

                    </b-form-group>
                    <!-- MULTIRADIO TYPE -->
                    <b-form-group v-if="selected_n.type=='multi_radio'" class="indent_bug">
                        <b-form-group class="indent_bug">
                            <b-button block @click="selected_n.multi.splice(0, 0, {'label': 'Enter label', 'text':'', 'type':'radio', 'options': [{'text': 'Option', 'value':''}, {'text': 'Option', 'value':''}]})">Insert new checklist item</b-button>
                            <p></p>
                            <template v-for="nn in selected_n.multi">
                                <b-card>
                                    <template #header>
                                        <b-button variant="danger" class="float-right" @click="selected_n.multi.splice(selected_n.multi.indexOf(nn), 1)">Delete</b-button>
                                    </template>
                                    <b-form v-if="nn.options != '' && nn.type == 'radio'">
                                        <b-input-group prepend="Label">
                                            <b-form-input :value="nn.label" @change="nn.label = $event">
                                            </b-form-input>
                                        </b-input-group>
                                        <b-form v-if="nn.options != '' && nn.type == 'radio'">
                                            <b-input-group prepend="Text for first option">
                                                <b-form-input :value="nn.normaltext" @change="nn.normaltext = $event">
                                                </b-form-input>
                                            </b-input-group>
                                            <template v-for="n_check in nn.options">
                                                <b-row>
                                                    <b-col cols="8">
                                                        <b-form-input :value="n_check.text" @change="n_check.text = $event">
                                                        </b-form-input>
                                                    </b-col>
                                                    <b-col>
                                                        <b-button-group>
                                                            <b-button variant="danger" @click=" nn.options.splice(nn.options.indexOf(n_check), 1)">-</b-button>
                                                            <b-button variant="success" @click="nn.options.splice(nn.options.indexOf(n_check)+1, 0, {'text': '', 'value': nn.options.indexOf(n_check)+1})">+</b-button>
                                                        </b-button-group>
                                                    </b-col>
                                                </b-row>
                                            </template>
                                            <b-form-checkbox v-model="nn.dont_print_normal">Don't mention in report if normal?</b-form-checkbox>
                                            </b-form>
                                    </b-form>
                                </b-card>
                                <p></p>
                                <b-button block @click="selected_n.multi.splice(selected_n.multi.indexOf(nn)+1, 0, {'label': 'Enter label', 'text':'', 'type':'radio', 'options': [{'text': 'Option', 'value':''}, {'text': 'Option', 'value':''}]})">Insert new checklist item</b-button>
                                <p></p>
                                </b-form>
                                <b-form-group v-show="nn.selected >= nn.showdetailson">
                                    <b-form-textarea :value="nn.details" @change="nn.details = $event">
                                    </b-form-textarea>
                                </b-form-group>
                            </template>
                        </b-form-group>
                    </b-form-group>
                    <!-- MULTI CHECKBOX TYPE -->
                    <b-form-group v-if="selected_n.type == 'multi_checkbox'">
                        <b-input-group prepend="Element label">
                            <b-form-input :value="selected_n.label" @change="selected_n.label = $event">
                            </b-form-input>
                        </b-input-group>
                        <p></p>
                        <b-container>
                            <template v-for="n_check in selected_n.multi">
                                <b-row>
                                    <b-col cols="8">
                                        <b-form-input :value="n_check.text" @change="n_check.text = $event">
                                        </b-form-input>
                                    </b-col>
                                    <b-col>
                                        <b-button-group>
                                            <b-button variant="danger" @click="selected_n.multi.splice(selected_n.multi.indexOf(n_check), 1)">Remove</b-button>
                                            <b-button variant="success" @click="selected_n.multi.splice(selected_n.multi.indexOf(n_check)+1, 0, {'text': '', 'value': selected_n.multi.indexOf(n_check)+1, 'type': 'checkbox'} )">Add</b-button>
                                        </b-button-group>
                                    </b-col>
                                </b-row>
                            </template>
                        </b-container>
                    </b-form-group>
                </div>
                <template #modal-footer="{ close }">
                    <b-button @click="close()" variant="success">Ok</b-button>
                </template>
            </b-modal>
            <b-modal id="save_as_new_modal" title="Save As New">
                <b-form-group>
                    <label>Name</label>
                    <b-form-input :value="save_as_new_modal.new_name" @change="save_as_new_modal.new_name = $event"></b-form-input>
                    <div v-if="mode=='templates'">
                        <label>Specialty</label>
                        <b-form-select :options="specialties" v-model="save_as_new_modal.new_specialty"></b-form-select>
                        <p></p>
                        <b-form-input v-if="save_as_new_modal.new_specialty=='Other'" v-model="save_as_new_modal.other_specialty" @change=""></b-form-input>
                        <label>Modality</label>
                        <b-form-select :options="modalities" v-model="save_as_new_modal.new_modality"></b-form-select>
                        <p></p>
                        <b-form-input v-if="save_as_new_modal.new_modality=='Other'" v-model="save_as_new_modal.other_modality" @change=""></b-form-input>
                        <label>Body Region</label>
                        <b-form-select :options="regions" v-model="save_as_new_modal.new_region"></b-form-select>
                        <p></p>
                        <b-form-input v-if="save_as_new_modal.new_region=='Other'" v-model="save_as_new_modal.other_region" @change=""></b-form-input>
                        <p></p>
                        <b-form-checkbox v-model="save_as_new_modal.publish">
                            Make this template available publicly (clinical information will NOT be shared)
                        </b-form-checkbox>
                    </div>
                </b-form-group>
                <template #modal-footer="{ close }">
                    <b-button variant="success" @click="saveAsNew();$bvModal.hide('save_as_new_modal')">Submit</b-button>
                </template>
            </b-modal>
            <b-modal id="delete_template" title="Confirm deletion?">
                <b-form-group>
                    <p>Delete this template?</p>
                </b-form-group>
                <template #modal-footer="{ Close }">
                    <b-button variant="success" @click="$bvModal.hide('delete_template')">Cancel</b-button>
                    <b-button variant="danger" @click="deleteTemplate();$bvModal.hide('delete_template')">Delete</b-button>
                </template>
            </b-modal>
            <b-modal id="delete_module" title="Confirm deletion?">
                <b-form-group>
                    <p>Delete this module?</p>
                </b-form-group>
                <template #modal-footer="{ Close }">
                    <b-button variant="success" @click="$bvModal.hide('delete_template')">Cancel</b-button>
                    <b-button variant="danger" @click="deleteModule();$bvModal.hide('delete_module')">Delete</b-button>
                </template>
            </b-modal>
            <!--------------------------------------------------------------------------------------------------------->
            <!--------------------------------------------------------------------------------------------------------->
            <div id="app_body">
                <b-form-group v-if="template != ''">
                    <b-card bg-variant="light">
                        <template #header>
                            <b-navbar>
                                <b-button-group style="margin-right:10px">
                                    <b-button variant="danger" @click="reset()">Close</b-button>
                                    <b-button variant="success" @click="copyReport()">Show Report</b-button>
                                    <b-button v-if="mode=='templates'" variant="warning" @click="clearTemplate()">Clear</b-button>
                                    <b-button v-if="mode=='templates'" v-b-modal.template_help_modal variant="info">Help</b-button>
                                    <b-dropdown v-if="mode=='templates'" class="float-right" right text="Template">
                                        <b-dropdown-item @click="saveChanges()">Save changes</b-dropdown-item>
                                        <b-dropdown-item v-b-modal.save_as_new_modal>Save as new</b-dropdown-item>
                                        <b-dropdown-item @click="publishToStore()">Publish to template store</b-dropdown-item>
                                        <b-dropdown-item v-b-modal.delete_template>Delete</b-dropdown-item>
                                    </b-dropdown>
                                    <b-dropdown v-if="mode=='modules'" class="float-right" right text="Module">
                                        <b-dropdown-item @click="exportXML_modules()">Save changes</b-dropdown-item>
                                        <b-dropdown-item v-b-modal.save_as_new_modal>Save as new</b-dropdown-item>
                                        <b-dropdown-item v-b-modal.delete_module>Delete</b-dropdown-item>
                                    </b-dropdown>
                                </b-button-group>
                                <div v-if="mode=='modules'" style="right: 0" id="template_name"><b>Module: {{templateForm.name}}<b></div>
                                <div v-if="mode=='templates'" style="right: 0" id="template_name"><b>{{templateForm.name}}<b></div>
                            </b-navbar>
                        </template>
                        <b-button v-if="mode=='templates'" style="margin-right:10px" variant="outline-primary" id="timer">Time in report: {{timer.min}} min</b-button>
                        <b-button v-if="mode=='templates'" style="margin-right:10px" variant="outline-primary" id="timer">Reports today: {{prefs.report_count_today}}</b-button>
                        <template v-for=" n in templateForm">

                            <div class="row">
                                <div class="control">
                                    <div class="op_icon">
                                        <b-dropdown id="dropdown-1" text="Edit" class="m-md-2">
                                            <b-dropdown-item v-if="templateForm.length>1" @click="selectElement(n); deleteElement()">Delete</b-dropdown-item>
                                            <b-dropdown-item @click="selectElement(n); insertObject('text')">Insert Text</b-dropdown-item>
                                            <b-dropdown-item @click="selectElement(n); insertObject('component')">Insert Component</b-dropdown-item>
                                            <b-dropdown-item v-if="mode=='templates'" @click="selectElement(n); insertObject('module')">Insert Module</b-dropdown-item>
                                            <b-dropdown-item v-b-modal.edit_modal @click="setupEdit(n)">Edit Element</b-dropdown-item>
                                            <b-dropdown-item @click="moveElement(n, 'up')">Move up</b-dropdown-item>
                                            <b-dropdown-item  @click="moveElement(n, 'down')">Move down</b-dropdown-item>
                                        </b-dropdown>
                                    </div>
                                </div>
                                <div class="element" v-if="n.hide != true">
                                    <!-- HEADER TYPE -->
                                    <h2 v-if="n.type == 'h1'">{{n.label}}</h2>
                                    <h3 v-if="n.type == 'h2'">{{n.label}}</h3>
                                    <!-- QUERY INSERT TYPE -->
                                    <button class="el_border" v-if=" n.type=='query_insert' && !n.meta.id" @click="queryInsert(n)">Insert {{n.text}}</button>
                                    <b-button variant="link" v-if=" n.type=='query_insert' && n.meta.id" @click="queryInsert(n)">Insert {{n.text}}</b-button>
                                    <!--  TEXT TYPE -->
                                    <label class="el_border" v-if=" n.type=='text'">{{n.text}}</label>
                                    <!-- FREE TEXT TYPE -->
                                    <div class="el_border" :label=" n.label" v-if="n.type == 'free_text'" :disabled="n.disabled">
                                        <b-form-textarea :value="n.text" @change="n.text = $event">
                                        </b-form-textarea>
                                    </div>
                                    <!-- TEXT ENTRY TYPE SMALL/MEDIUM/LARGE -->
                                    <div class="el_border" :disabled="n.disabled" v-if="n.type == 'text_entry'">
                                        <label v-if="n.subtype  != 'small' && n.label != '' && n.no_label != true" md="auto">{{n.label}}</label>
                                        <b-input-group :prepend="n.label" v-if="n.subtype  == 'small'">
                                            <b-form-input :value="n.text" @change="n.text = $event">
                                        </b-input-group>
                                        </b-form-input>
                                        <b-form-textarea :value="n.text" @change="n.text = $event" v-if="n.subtype  == 'medium'">
                                        </b-form-textarea>
                                        <b-form-textarea :value="n.text" @change="n.text = $event" rows="8" v-if="n.subtype  == 'large'">
                                        </b-form-textarea>
                                    </div>
                                    <!-- SELECTION TYPE -->
                                    <div class="el_border" :disabled="n.disabled" v-if="n.type == 'selection'">
                                        <b-form inline>
                                            <label class="mb-2 mr-sm-2 mb-sm-0">{{n.label}}</label>
                                            <b-form-select v-model="n.selected" :options="n.options" @input="n.details = Boolean(n.selected >= n.showdetailson)">
                                            </b-form-select>
                                        </b-form>
                                    </div>
                                    <!-- MULTISELECTION TYPE -->
                                    <div v-if="n.type=='multi_select'">
                                        <b-form inline>
                                            <label class="mb-2 mr-sm-2 mb-sm-0">{{n.label}}</label>
                                            <b-form-radio-group v-if="n.askfurtherdetails =='true'" :options="n.present_options" v-model="n.present" class="mb-2 mr-sm-2 mb-sm-0">
                                            </b-form-radio-group>
                                        </b-form>
                                        <b-row cols="1" cols-sm="2">
                                            <template v-for="nn in n.multi">
                                                <b-col>
                                                    <b-form-group label-size="sm" v-if="nn.type == 'dropdown' && (nn.options != '' && n.present == 'Yes' || n.askfurtherdetails !='true')" :label="nn.label" label-cols="3">
                                                        <b-form-select style="font-size: xx-small!;" :options="nn.options" v-model="nn.selected">
                                                        </b-form-select>
                                                    </b-form-group>
                                                    <b-form-group label-size="sm" v-show="(nn.type == 'dropdown' && (n.present == 'Yes' || n.askfurtherdetails !='true')) && nn.selected == (nn.options.length-1)" label-cols="3">
                                                        <b-form-input :value="nn.text" @change="nn.text = $event" placeholder="Other">
                                                        </b-form-input>
                                                    </b-form-group>
                                                    <b-form-group label-size="sm" v-if="nn.type == 'free_text' && (nn.options != '' && n.present == 'Yes' || n.askfurtherdetails !='true')" :label="nn.label" label-cols="3">
                                                        <b-form-input :value="nn.text" @change="nn.text = $event">
                                                        </b-form-input>
                                                    </b-form-group>
                                                </b-col>
                                            </template>
                                        </b-row>
                                    </div>
                                    <!-- MULTIRADIO TYPE -->
                                    <div v-if="n.type == 'multi_radio'" :disabled="n.disabled">
                                        <template v-for="nn in n.multi">
                                            <b-form inline v-if="nn.options != '' && nn.type == 'radio'">
                                                <label class="mb-2 mr-sm-2 mb-sm-0">{{nn.label + ": "}}</label>
                                                <b-form-radio-group :options="nn.options" v-model="nn.selected" class="mb-2 mr-sm-2 mb-sm-0">
                                                </b-form-radio-group>
                                            </b-form>
                                            <b-form-group v-if="nn.selected >= nn.showdetailson">
                                                <b-form-textarea :value="nn.details" @change="nn.details = $event">
                                                </b-form-textarea>
                                            </b-form-group>
                                        </template>
                                    </div>
                                    <!-- MULTI CHECKBOX TYPE -->
                                    <div class="el_border" v-if="n.type == 'multi_checkbox'" :disabled="n.disabled">
                                        <label>{{n.label}}</label>
                                        <b-container class="bv-example-row">
                                            <b-row cols="1" cols-sm="2">
                                                <template v-for="nn in n.multi">
                                                    <b-col>
                                                        <b-form-checkbox plain v-model="nn.selected">
                                                            {{nn.text}}
                                                        </b-form-checkbox>
                                                    </b-col>
                                                </template>
                                            </b-row>
                                        </b-container>
                                    </div>
                                    <!-- DETAILS BOX -->
                                    <div v-show="n.details || n.present == 'Yes'" :disabled="n.disabled">
                                        <b-form-textarea :value="n.details_text" @change="n.details_text = $event">
                                            Details
                                        </b-form-textarea>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </b-card>
                </b-form-group>
            </div>
        </b-container>
    </div>
    <script>

    /* GLOBAL VARIABLES */

    window.app = new Vue({
        components: {
            //VueBootstrapTypeahead
        },
        el: '#app',
        data: {
            mode: 'templates',
            edit_mode: 'templates',
            modalities: [],
            specialties: [],
            regions: [],
            module: "",
            components: loadXML("static/xml/components.xml"),
            templates: loadXML("static/xml/empty.xml"),
            reportText: "",
            template: "", // Pointer to the template in the templates array
            index: "",
            templateForm: [], // The current form being worked on
            selected_n: null, // Currently selected element object
            user_name: '',
            user_name_submit: '',
            user_email: '',
            user_password: '',
            logged_in: false,
            new_template_name: '',
            import_file: null,
            template_changed: null,
            radreport_titles: [],
            radreport_table: [],
            radreport_search_term: '',
            show_count: false,
            importing: false,
            prefs: {},
            alert_message: "",
            alert_countdown: 0,
            copyButtonText: 'Copy to clipboard',
            AIButtonText: 'AI review',
            timer: { // Times how long each report is taking
                id: 0,
                sec: 0,
                min: 0,
                report_count:0,
                last_logged_in:0
            },
            editModal: {
                value: "null"
            },
            copyModal: {
                id: 'copy-modal',
                title: "Copy",
                text: '',
                text_changed:true,
                ai_text: ''
            },
            xmlModal: {
                id: 'xml-modal',
                title: "XML",
                text: ''
            },
            object: {
                type: null,
                position: 'below'
            },
            save_as_new_modal: {
                new_name: null,
                new_specialty: null,
                new_modality: null,
                new_region: null,
                other_specialty: null,
                other_modality: null,
                other_region: null,
                publish: false
            }
        },
        beforeCreate() {

            fetch(`${window.origin}/check-login`, {
                    method: "GET",
                    credentials: "include",
                    cache: "no-cache",
                    headers: new Headers({
                        "content-type": "application/json"
                    })
                })
                .then(response => {
                    if (response.ok) {

                    }
                    if (response.status !== 200) {
                        alert("Login failure " + response.status)

                        return;
                    }
                    return response.json()
                })
                .then(xml => {
                    this.user_name = xml.username;
                    this.logged_in = true;
                    this.prefs = JSON.parse(xml.prefs) ? JSON.parse(xml.prefs) : {}
                    var todays_date = (new Date()).toDateString();

                    if (typeof this.prefs.copytab === 'undefined') this.prefs.copytab = 0;
                    if (typeof this.prefs.include_signature === 'undefined') this.prefs.include_signature = false;
                    if (typeof this.prefs.generate_conclusion === 'undefined') this.prefs.generate_conclusion = false;
                    if (typeof this.prefs.last_logged_in === 'undefined') this.prefs.last_logged_in = todays_date;
                    if (typeof this.prefs.report_count_today === 'undefined' || this.prefs.last_logged_in != todays_date) this.prefs.report_count_today = 0;

                    var obj = this.update_templates(xml.templates_modules, this.templates);
                })
                .catch(function(error) {
                    console.log("Fetch error: " + error);
                });

        },

        created() {

            this.get_templates();
            //this.debouncedSavePrefs = _.debounce(this.save_prefs, 900);

        },
        watch: {

        },
        methods: {
            showAlert: function(text) {
                this.alert_countdown = 4;
                this.alert_message = text;

            },
            save_prefs: function() {
              console.log("prefs saved")
                save_prefs(this.prefs)
            },

            edit_modules: function() {
                this.mode = 'modules'
            },

            import_templates_from_server: function(name) {

                var entry = {
                    name: name
                }

                fetch(`${window.origin}/import-templates`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(entry),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                        }
                        if (response.status !== 200) {
                            alert("Login failure " + response.status)
                            return;
                        }
                        return response.json()
                    })
                    .then(xml => {
                        var obj = this.update_templates(xml.templates_modules, this.templates, false);
                        updateUserDatabase(this.templates, this.templates.modules)
                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });

            },
            loadXML_new: function(path_template, path_user) {
                var xhttp = new XMLHttpRequest();
                var temp = [];
                xhttp.my_func = this.update_templates
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        temp = parseXML(this.responseXML, temp);

                        //console.log(temp)
                        //var obj = this.update_templates(this.responseXML, this.templates, false);

                    }
                };
                xhttp.open("GET", path_template, true);
                xhttp.send();

                return temp;
            },

            import_templates_from_file: function(import_file) {
                var file = import_file;
                if (!file) {
                    return;
                }


                var reader = new FileReader();
                reader.context = this;
                reader.onload = function(e) {
                    var contents = e.target.result;
                    xml = contents;

                    if (xml != null) {
                        var parser = new DOMParser();
                        xmlDoc = parser.parseFromString(xml, "text/xml");
                        if (xmlDoc.getElementsByTagName("html").length == 1) {
                            var user = parse_radreport(xml);
                            merge_templates(this.context.templates, user, true);
                            this.context.selectTemplate(user[0]);
                        } else if (xmlDoc.getElementsByTagName("all").length != 0) {

                            this.context.update_templates(xml, null, false);
                        }
                    }
                }
                reader.readAsText(file);
            },

            get_templates: function() {
                fetch(`${window.origin}/radreport-list`, {
                        method: "GET",
                        credentials: "include",
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                        }
                        if (response.status !== 200) {
                            alert("Failure " + response.status);
                            return;
                        }
                        return response.json()
                    })
                    .then(json => {
                        t_radreport_titles = json.DATA;

                        for (var n = 0; n < t_radreport_titles.length; n++) {
                            if (t_radreport_titles[n].lang == "English") {
                                this.radreport_titles.push({
                                    "title": t_radreport_titles[n].title,
                                    "template_id": t_radreport_titles[n].template_id,
                                    "template_version": t_radreport_titles[n].template_version,
                                    "specialty": t_radreport_titles[n].specialty
                                })
                            }
                        }

                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });
            },

            update_radreport_search() {
                this.radreport_table = this.radreport_titles.filter(t => {
                    return (t.title.toLowerCase().search(this.radreport_search_term.toLowerCase()) != -1)
                })
            },

            download_radreport: function(item) {

                fetch(`${window.origin}/radreport-get-template`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(item),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                        }
                        if (response.status !== 200) {
                            alert("Failure " + response.status)
                            return;
                        }
                        return response.json()
                    })
                    .then(json => {
                        var id = json.template_id;
                        var rad_meta = this.radreport_titles.find(t => {
                            return t.template_id == id;
                        });
                        console.log(rad_meta);

                        var user = parse_radreport(json.xml, "specialty", "modality", "region");
                        merge_templates(this.templates, user, true);
                        this.selectTemplate(user[0]);
                        this.$root.$emit('bv::hide::modal', 'template-download');
                        this.importing = false;
                    })
                    .catch(error => {
                        alert("Sorry I could not obtain that one. This is an experimental feature still being worked on...");
                        this.$root.$emit('bv::hide::modal', 'template-download');
                        this.importing = false;
                    });

            },

            download_templates: function() {
                fetch(`${window.origin}/check-login`, {
                        method: "GET",
                        credentials: "include",
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                        }
                        if (response.status !== 200) {
                            alert("Login failure " + response.status)

                            return;
                        }
                        return response.json()
                    })
                    .then(xml => {
                        var save = "<?xml version=\"1.0\" encoding=\"ISO8859-1\"?>" + xml.templates_modules;


                        save_to_file(save, "my_templates.xml", "text/xml")


                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });
            },

            items_in_list: function(specialty, modality, region) {
                var is_in = this.templates.filter(x => {
                    return x.specialty == specialty;
                })

                if (modality) is_in = is_in.filter(x => {
                    return x.modality == modality;
                });

                if (region) is_in = is_in.filter(x => {
                    return x.region == region;
                });

                return is_in.length;
            },
            update: function(event) {},

            findList: function(text, symbol_start, symbol_end) {
                var n = 0 - symbol_start.length;
                do {
                    n = text.indexOf(symbol_start, n + symbol_start.length);
                    if (n != -1) {
                        end = text.indexOf(symbol_end, n);
                    }
                } while (n != -1);
                return text;
            },



            start_timer: function() {
                this.timer.sec = 0;
                this.timer.min = 0;
                clearInterval(this.timer.id);

                function count() {
                    this.timer.sec++;
                    if (this.timer.sec == 60) {
                        this.timer.min++;
                        this.timer.sec = 0;
                    }
                }

                this.timer.id = setInterval(count.bind(this), 1000); // setTimeout delay time 100 milliseconds
            },

            clearTemplate: function() {
                var temp = this.templates.find(t => {
                    return t.name == this.templateForm.name
                })
                this.reset();
                this.selectTemplate(temp);
            },

            reset: function() {
                this.save_as_new_modal.new_name = null;
                this.save_as_new_modal.new_specialty = null;
                this.save_as_new_modal.new_modality = null;
                this.save_as_new_modal.new_region = null;
                this.save_as_new_modal.other_specialty = null;
                this.save_as_new_modal.other_modality = null;
                this.save_as_new_modal.other_region = null;
                this.save_as_new_modal.publish = null;

                this.reportText = "";
                this.module = "";
                this.template = "";
                this.index = "";
                this.templateForm = [];
                this.selected_n = null;


            },

            selectTemplate: function(event) {
                this.reset();
                this.template = event;
                this.writeTemplate();
                window.scrollTo(0, 0);
                this.start_timer();
            },

            selectModule: function(event) {
                this.module = event;
            },

            writeTemplate: function() { // Writes the form from the selected template
                this.templateForm = [];
                this.templateForm = parseFindings(this.template.xml.childNodes, this.templates.modules)
                for (var n = 0; n < this.templateForm.length; n++) {
                    this.templateForm[n].array_id = unique_id();
                }
                this.templateForm.name = this.template.name;
                this.templateForm.modality = this.template.modality;
                this.templateForm.region = this.template.region;
                this.templateForm.specialty = this.template.specialty;
                this.save_as_new_modal.new_name = this.template.name;
                this.save_as_new_modal.new_specialty = this.template.specialty;
                this.save_as_new_modal.new_modality = this.template.modality;
                this.save_as_new_modal.new_region = this.template.region;

            },

            blankTemplate: function() {
                var index = this.templates.find(i => {
                    return (i.name.trim() == "Blank")
                });
                this.selectTemplate(index);

            },

            blankModule: function() {
                var index = this.templates.modules.find(i => {
                    return (i.name.trim() == "Blank")
                });
                this.selectTemplate(index);

            },

            n_from_element(element) { // Returns n in templateform of element
                var index = this.templateForm.findIndex(i => {
                    return (i.array_id == element.array_id)
                });
                return index;
            },

            deleteElement() {
                var index = this.n_from_element(this.selected_n)
                this.templateForm.splice(index, 1);
            },

            deleteModule() {
                if (this.templateForm.name == "Blank") { alert("You cannot delete the blank module"); return; }

                var i = this.templates.modules.findIndex(n => {
                    return (n.name == this.templateForm.name);
                });
                this.templates.modules.splice(i, 1);
                updateUserDatabase(this.templates, this.templates.modules);
                this.reset();


            },

            deleteTemplate() {
                if (this.templateForm.name == "Blank") { alert("You cannot delete the blank template"); return; }

                var i = this.templates.findIndex(n => {
                    return (n.name == this.templateForm.name);
                });
                this.templates.splice(i, 1);
                updateUserDatabase(this.templates, this.templates.modules);
                this.reset();
            },

            delete_all_templates() {
                var temp = this.templates.modules;
                this.templates = this.templates.filter(n => {
                    return (n.name == "Blank")
                })
                this.templates.modules = temp;

                updateUserDatabase(this.templates, this.templates.modules);
                this.reset();
            },
            delete_all_modules() {
                //var temp = this.templates.modules;
                this.templates.modules = this.templates.modules.filter(n => {
                    return (n.name == "Blank")
                })
                updateUserDatabase(this.templates, this.templates.modules);
                this.reset();
            },
            queryInsert: function(element) {
                if (-1 == this.templates.modules.findIndex(n => { return (n.name == element.text) })) {
                    alert("Module not installed!")
                    return
                };

                this.selectElement(element);
                var selected = this.n_from_element(this.selected_n)
                selected = selected - 1;
                this.module = this.templates.modules.find(function(i) {
                    return i.name == element.text;
                });

                this.insertModule(null, "above", element.disappear, true);
            },
            insertObject(type, position = false) {
                var index = this.n_from_element(this.selected_n);
                this.object.type = type;
                if (index == 0 && position == false) {
                    this.$root.$emit('bv::show::modal', 'position-insert-modal');
                } else {
                    this.object.position = position;
                    // Component
                    if (this.object.type == "component") this.$root.$emit('bv::show::modal', 'insert-component-modal');
                    // Text entry
                    if (this.object.type == "text") this.insertComponent("Text Entry", true);
                    // Module
                    if (this.object.type == "module") this.$root.$emit('bv::show::modal', 'control_modal');
                }
            },

            // Insert module after selected element. If no values passed then uses module in this.module
            insertModule(selected_module, position, disappear, dont_save = false) {
                var offset = (this.object.position == 'above') ? -1 : 0;
                var place = 0;
                if (position == "below") place = 1;

                if (selected_module) {
                    this.module = this.templates.modules.find(function(i) {
                        return i.name == selected_module;
                    });
                }
                var module_data = _.cloneDeep(this.module)
                var module_id = unique_id();
                var index_start = this.n_from_element(this.selected_n) + offset + place;

                if (disappear) {
                    //this.templateForm.splice(this.n_from_element(this.selected_n), 1)
                    this.selected_n.hide = true;
                }

                for (var n = 0; n < module_data.elements.length; n++) {
                    module_data.elements[n].array_id = unique_id();
                    module_data.elements[n].meta.id = module_id;
                    module_data.elements[n].dont_save = dont_save;
                    this.templateForm.splice(index_start + n, 0, module_data.elements[n]);
                }


                this.object.type = null;
                this.object.position = null;
            },


            insertComponent(component_name, dont_show_options) {
                this.$root.$emit('bv::hide::modal', 'insert-component-modal');
                var offset = (this.object.position == 'above') ? 0 : 1;

                var index = this.n_from_element(this.selected_n);
                var component = this.components.modules.findIndex(i => {
                    return (i.name == component_name)
                });

                //var module_data = _.cloneDeep(this.components.modules[component].elements[0]);
                var module_data = parseFindings(this.components.modules[component].xml.childNodes, this.templates.modules)[0]

                module_data.meta = {
                    this_is_module: false,
                }
                module_data.array_id = unique_id();
                //module_data.present = true
                this.templateForm.splice(this.n_from_element(this.selected_n) + offset, 0, module_data);

                if (!dont_show_options) {
                    this.selectElement(module_data);
                    this.setupEdit(module_data);
                    this.$root.$emit('bv::show::modal', 'edit_modal');
                }
                this.object.type = null;
                this.object.position = null;
            },
            selectElement(element) {
                this.selected_n = element
            },

            setupEdit(element) {
                this.selectElement(element);
                this.editModal.value = JSON.stringify(this.templateForm[this.n_from_element(this.selected_n)]);

            },
            moveElement(element, direction) {
                this.selectElement(element);
                var index = this.n_from_element(this.selected_n);

                if (direction === 'up' && index > 0) {
                    // Move the element up
                    const temp = this.templateForm[index - 1];
                    this.$set(this.templateForm, index - 1, this.templateForm[index]);
                    this.$set(this.templateForm, index, temp);
                    // Update the selection to the new position
                    this.selectElement(this.templateForm[index - 1]);
                } else if (direction === 'down' && index < this.templateForm.length - 1) {
                    // Move the element down
                    const temp = this.templateForm[index + 1];
                    this.$set(this.templateForm, index + 1, this.templateForm[index]);
                    this.$set(this.templateForm, index, temp);
                    // Update the selection to the new position
                    this.selectElement(this.templateForm[index + 1]);
                }
            },
            copyReport: function() {
              this.clearClipboard();
              this.AIButtonText = "AI Review"
              this.copyButtonText = "Copy to clipboard"
              this.copyModal.text_changed=true;

              var copyText = "";
                for (var n = 0; n < this.templateForm.length; n++) {
                    copyText += this.templateForm[n].printContents();
                }
                // Some grammar corrections
                copyText = copyText.trim();
                copyText = copyText.replace(/(\n){3,}/g, "\n\n"); // Remove triple or more newlines
                copyText = copyText.replace(/\b(left|right)\b/gi, function(match) {
                    return match.toUpperCase();
                  });

                // Display Modal
                this.copyModal.ai_text = "Generating report using AI..."
                this.copyModal.text = copyText;
                this.AIReview();
                this.$root.$emit('bv::show::modal', this.copyModal.id);

            },

            clipboardReport: function() { // Put in clipboard
              this.copyButtonText = 'Copied!';
              setTimeout(() => { this.copyButtonText = 'Copy to Clipboard'; }, 2000);

              if (this.prefs.copytab == 0) {copyText = this.copyModal.text;}
                else {copyText = this.copyModal.ai_text}
              if (this.prefs.include_signature) copyText += "\n\n" + this.prefs.signature;

                const listener = function(ev) {
                    ev.preventDefault();
                    ev.clipboardData.setData('text/plain', copyText);
                };
                document.addEventListener('copy', listener);
                document.execCommand('copy');
                document.removeEventListener('copy', listener);
            },

            clearClipboard: function() {
                const listener = function(ev) {
                    ev.preventDefault();
                    ev.clipboardData.setData('text/plain', "");
                };
                document.addEventListener('copy', listener);
                document.execCommand('copy');
                document.removeEventListener('copy', listener);

            },
            AIReview: function() {
              if(!this.copyModal.text_changed) {return;}
              this.copyModal.text_changed = false;

              report = {}
              prompt = "Please return the following radiology report in JSON format: (1) = main_text (string) (2) = summary (string). Within main_text and summary there should be no objects just plain text. (1) Return a text string correcting grammar and spelling whilst changing as little as possible. Noun phrases are required to be completed with a determiner. Correct typos and redundant words. Always preserve the headings (i.e. TECHNIQUE, COMPARISON, FINDINGS, CONCLUSION, etc). Always write in full sentences using prose (except for the headings) and do not use lists. Write in present tense. Always preserve and include newlines. There should be a newline after headings. Never make up findings or headings or clinical indications. You may combine normal findings. Return in JSON as 'main_text'. (2) Provide a concise conclusion to the provided radiology report. Omit negative findings. Don't repeat indication, technique, or comparison in the conclusion. You may write in noun sentences. Return in JSON as 'summary'. Text follows:"
              report.text = "Your response should be in JSON format." + prompt + this.copyModal.text;

              //if(!/CONCLUSION:\s*(\S+)/.test(text))
              //this.AIButtonText = 'AI is reviewing!';
              this.copyModal.ai_text = "Generating report using AI..."

              fetch(`${window.origin}/AIReview`, {
                      method: "POST",
                      credentials: "include",
                      body: JSON.stringify(report),
                      cache: "no-cache",
                      headers: new Headers({
                          "content-type": "application/json"
                      })
                  })
                  .then(response => {
                      if (response.ok) {

                      }
                      if (response.status !== 200) {
                          alert("Failure " + response.status)
                          return;
                      }
                      return response.json()
                  })
                  .then(json => {
                    console.log(json.reviewed);

                     this.copyModal.ai_text = JSON.parse(json.reviewed).main_text.trim();
                    if(this.prefs.generate_conclusion) {this.copyModal.ai_text += "\n" + JSON.parse(json.reviewed).summary}

                  })
                  .catch(error => {
                      alert("Sorry error. ");
                      this.$root.$emit('bv::hide::modal', 'template-download');
                      this.importing = false;
                  });
            },

            // Saves this module locally (and then calls to save on server)
            exportXML_modules: function() {
                if (this.templateForm.name == "Blank") {
                    alert("You cannot make changes to this blank template");
                    return;
                }

                // First I turn the gui elements to xml and then back again to blank the entries.
                var xml_doc = document.implementation.createDocument("", "", null);
                var template_gui = this.templateForm;

                // Build new template xml from GUI
                template = template_to_xml(template_gui, xml_doc);
                var new_element = {
                    name: this.templateForm.name,
                    elements: parseFindings(template.querySelector("content").childNodes, this.templates.modules),
                    xml: template.querySelector("content")

                }

                var exists_in_user_modules = null;
                for (var n = 0; n < this.templates.modules.length; n++) {
                    if (this.templates.modules[n].name == this.templateForm.name) {
                        this.templates.modules[n] = new_element;
                        exists_in_user_modules = true;
                    }
                }
                if (!exists_in_user_modules) {
                    this.templates.modules.push(new_element);
                }

                // Save to server
                updateUserDatabase(this.templates, this.templates.modules);

                this.showAlert("Saved successfully");
            },

            // Saves this template locally (and then calls to save on server)
            exportXML_templates: function(publish_to_store = false) {
                // I turn the gui elements to xml and then back again to blank the entries.
                var xml_doc = document.implementation.createDocument("", "", null);
                var template_gui = _.cloneDeep(this.templateForm);

                // Remove any "don't save" elements (inserted by query_insert)
                template_gui = template_gui.filter(n => {
                    if (n.dont_save && n.dont_save == true) return false
                    else return true;
                });

                // Search in the template for modules
                var module_array = []
                for (var n = 0; n < template_gui.length; n++) {
                    if (template_gui[n].meta.this_is_module) {
                        var temp_module = [];
                        var module_id = template_gui[n].meta.id;
                        temp_module.push(template_gui[n]);
                        if (template_gui[n + 1] && template_gui[n + 1].meta.id == module_id && (n + 1) < template_gui.length) {
                            do {
                                temp_module.push(template_gui[n + 1]);
                                n++;
                            }
                            while ((n + 1) < template_gui.length && template_gui[n + 1].meta.id == module_id)
                        }
                        module_array.push(temp_module);
                    }
                }

                // Check modules to see whether they have changed
                module_array.forEach(n => {
                    var temp_module = [];
                    for (var nn = 0; nn < n.length; nn++) {
                        temp_module.push(_.cloneDeep(n[nn]))
                        delete temp_module[nn].meta.id;
                        delete temp_module[nn].array_id;
                    }
                    var i = this.templates.modules.find(m => {
                        return (m.name == n[0].meta.module_name)
                    });

                    if (JSON.stringify(temp_module) != JSON.stringify(i.elements)) {
                        module_array = module_array.filter(m => {
                            return !(m[0].meta.id == n[0].meta.id)
                        })
                    }
                })

                // Remove modules and replace with "Insert"
                for (var n = 0; n < module_array.length; n++) {
                    var id = module_array[n][0].meta.id;
                    var index = template_gui.findIndex(x => {
                        if (x.meta.this_is_module && x.meta.id == id) return true;
                        else return false;
                    });
                    template_gui.splice(index, module_array[n].length);

                    template_gui.splice(index, 0, {
                        type: "insert",
                        module: module_array[n][0].meta.module_name,
                        meta: {
                            this_is_module: false
                        },
                        exportTemplate: function(xml_doc) {
                            var xml_el = xml_doc.createElement(this.type);
                            xml_el.innerHTML = this.module.trim();
                            return xml_el;
                        }
                    })
                }

                template = template_to_xml(template_gui, xml_doc);
                var new_template = {
                    name: this.templateForm.name.replace(/[\n\r]\t/g, '').trim(),
                    modality: this.templateForm.modality.replace(/[\n\r]\t/g, '').trim(),
                    region: this.templateForm.region.replace(/[\n\r]\t/g, '').trim(),
                    specialty: this.templateForm.specialty.replace(/[\n\r]\t/g, '').trim(),
                    elements: parseFindings(template.querySelector("content").childNodes, this.templates.modules, null),
                    xml: template.querySelector("content")
                }
                var xml = (new XMLSerializer()).serializeToString(template);

                // Search in the user_templates and replace if exists. If not then append.
                var exists_in_user_templates = null;
                for (var n = 0; n < this.templates.length; n++) {
                    if (this.templates[n].name == this.templateForm.name) {
                        this.templates[n] = new_template;
                        exists_in_user_templates = true;
                    }
                }
                if (!exists_in_user_templates) {
                    this.templates.push(new_template);
                }

                // Add this to template store
                if (publish_to_store == true) this.publish_template(new_template)

                // Update server templates
                updateUserDatabase(this.templates, this.templates.modules);

                this.showAlert("Saved successfully");
            },

            publish_template: function(template_passed) {
                template = _.cloneDeep(template_passed);

                // Get list of modules called by template
                modules_list = []
                var xml_template = template.xml.childNodes;

                find_modules(xml_template, this.templates.modules, modules_list);

                // Convert template into format that server can read
                template.xml = (new XMLSerializer()).serializeToString(template.xml);
                var json = {
                    template: template,
                    modules: modules_list
                }

                // Send to server
                fetch(`${window.origin}/publish-template`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(json),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                        }
                        if (response.status !== 200) {
                            alert("Login failure " + response.status)
                            return;
                        }
                        return response.json()
                    })
                    .then(xml => {
                        return;

                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });

            },

            // Reload templates/modules by adding xml to existing
            update_templates: function(xml, templates, overwrite = true) {
                templates = this.templates;


                //  Update modules
                if (xml != null) {
                    var parser = new DOMParser();
                    xmlDoc = parser.parseFromString(xml, "text/xml");
                    var user = []
                    var t = xmlDoc.getElementsByTagName("module");

                    for (var i = 0; i < t.length; i++) {
                        var t_name = t[i].querySelector(
                            "name").innerHTML.replace(/\t/g, '').trim();
                        var t_findings = t[i].querySelector(
                            "content").childNodes;
                        var elements = parseFindings(t_findings, null, t_name);

                        user.push({
                            name: t_name,
                            elements: elements,
                            xml: t[i].querySelector(
                                "content")
                        });
                    }
                    merge_templates(templates.modules, user, true)

                    // Parse user templates
                    var user = []
                    var t = xmlDoc.getElementsByTagName("template");

                    for (var i = 0; i < t.length; i++) {
                        var t_name = t[i].querySelector(
                            "name").innerHTML.replace(/[\n\r]\t/g, '').trim();
                        var t_modality = t[i].querySelector(
                            "modality");
                        if (t_modality) t_modality = t_modality.innerHTML.replace(/\t/g, '').trim();
                        var t_region = t[i].querySelector("region");
                        if (t_region) t_region = t_region.innerHTML.replace(/\t/g, '').trim();
                        var t_specialty = t[i].querySelector("specialty");
                        if (t_specialty) t_specialty = t_specialty.innerHTML.replace(/\t/g, '').trim();
                        var t_findings = t[i].querySelector(
                            "content").childNodes;
                        var elements = parseFindings(t_findings, templates.modules);
                        var text = t[i].querySelector("content").innerHTML

                        user.push({
                            name: t_name,
                            specialty: t_specialty,
                            region: t_region,
                            modality: t_modality,
                            elements: elements,
                            xml: t[i].querySelector(
                                "content")
                        });
                    }
                    merge_templates(templates, user, true)
                    templates.sort((a, b) => {
                        return (a.name > b.name)
                    });
                    templates.modules.sort((a, b) => {
                        return (a.name > b.name)
                    });
                }

                // Rework categories
                this.modalities = [];
                this.specialties = [];
                this.regions = [];

                templates.forEach(t => {
                    if (t.modality != null && t.modality != "") {
                        if (!this.modalities.find(n => {
                                return n == t.modality;
                            })) this.modalities.push(t.modality);
                        if (!this.specialties.find(n => {
                                return n == t.specialty;
                            })) this.specialties.push(t.specialty);
                        if (!this.regions.find(n => {
                                return n == t.region;
                            })) this.regions.push(t.region);
                    }

                });

                this.modalities.sort().push("Other");
                this.specialties.sort().push("Other");
                this.regions.sort().push("Other");

                this.templates = templates;
            },

            saveChanges: function() {
                if (this.templateForm.name != "Blank") this.exportXML_templates(false);
                else {
                    alert("You cannot make changes to this blank template")
                    this.$root.$emit('bv::show::modal', 'save_as_new_modal');
                }
            },

            publishToStore: function() {
                if (this.templateForm.name != "Blank") {
                    this.exportXML_templates(true);
                } else {
                    alert("You cannot make changes to this blank template")
                    this.$root.$emit('bv::show::modal', 'save_as_new_modal');
                }
            },

            saveAsNew: function() {
                var list = null;
                if (this.mode == 'templates') list = this.templates;
                else list = this.templates.modules;
                // Search if name already
                if (-1 != list.findIndex(n => {
                        return (n.name.trim() == this.save_as_new_modal.new_name.trim())
                    })) {
                    alert("Name already exists: " + this.save_as_new_modal.new_name);
                    return;
                } else {
                    this.templateForm.name = this.save_as_new_modal.new_name;
                    if (this.save_as_new_modal.new_specialty == "Other") this.templateForm.specialty = this.save_as_new_modal.other_specialty;
                    else this.templateForm.specialty = this.save_as_new_modal.new_specialty;
                    if (this.save_as_new_modal.new_modality == "Other") this.templateForm.modality = this.save_as_new_modal.other_modality;
                    else this.templateForm.modality = this.save_as_new_modal.new_modality;
                    if (this.save_as_new_modal.new_region == "Other") this.templateForm.region = this.save_as_new_modal.other_region;
                    else this.templateForm.region = this.save_as_new_modal.new_region;
                    document.getElementById("template_name").innerHTML = this.save_as_new_modal.new_name

                }
                if (this.mode == 'templates') {
                    this.exportXML_templates(this.save_as_new_modal.publish);
                } else this.exportXML_modules()

                this.update_templates(null, null)

            },

            login: function() {
                var entry = {
                    user_email: this.user_email,
                    user_password: this.user_password
                }

                fetch(`${window.origin}/login`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(entry),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                        }
                        if (response.status !== 200) {
                            alert("Login failure " + response.status)
                            return;
                        }
                        return response.json()
                    })
                    .then(xml => {
                        this.user_name = xml.username;
                        this.logged_in = true;
                        var obj = this.update_templates(xml.templates_modules, this.templates);
                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });


            },


            register: function() {
                var entry = {
                    user_email: this.user_email,
                    user_password: this.user_password,
                    user_name: this.user_name_submit
                }

                fetch(`${window.origin}/register`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(entry),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            alert("Registration success")
                            this.$root.$emit('bv::show::modal', 'login-modal');

                        }
                        if (response.status !== 200) {
                            alert("Registration failure " + response.status)

                            return;
                        }
                        return response
                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });

            },
            logout: function() {
                fetch(`${window.origin}/logout`, {
                        method: "POST",
                        credentials: "include",
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(response => {
                        if (response.ok) {

                            this.logged_in = false;
                            this.user_name = '';
                            this.user_password = '';
                            this.user_email = '';
                            window.location.reload(true)

                        }
                        if (response.status !== 200) {
                            alert("Registration failure " + response.status)

                            return;
                        }
                        return response
                    })
                    .catch(function(error) {
                        console.log("Fetch error: " + error);
                    });
            }
        }
    });
    </script>
</body>

</html>
